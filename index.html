<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Custodia Familiar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' x='0.1em' font-size='80'%3E%F0%9F%93%85%3C/text%3E%3C/svg%3E">
  <style>
    :root {
      --mother-color: #fce7f3; --father-color: #dbeafe;
      --mother-text: #be185d; --father-text: #1e40af;
      --accent-color: #7c3aed; --accent-soft: #ede9fe;
      --text-main: #111827; --bg-main: #f1f5f9;
      --success: #10b981; --error: #ef4444;
      --card-radius: 16px;
    }
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body { 
      margin: 0; 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
      background: var(--bg-main); 
      color: var(--text-main); 
      padding-bottom: 40px; 
    }
    
    .hidden { display: none !important; }

    /* --- TOASTS --- */
    .toast-container { position: fixed; bottom: 20px; left: 20px; right: 20px; z-index: 9999; pointer-events: none; display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .toast { background: #333; color: #fff; padding: 12px 20px; border-radius: 50px; font-size: 0.9rem; opacity: 0; transform: translateY(20px); transition: 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .toast.visible { opacity: 1; transform: translateY(0); }
    .toast.success { background: var(--success); } 
    .toast.error { background: var(--error); }

    /* --- LOGIN --- */
    .login-wrapper { min-height: 100vh; display:flex; align-items:center; justify-content:center; padding:16px; background: linear-gradient(135deg, #ede9fe 0%, #f3f4fb 100%); }
    .login-card { background:#fff; max-width:360px; width:100%; border-radius:24px; box-shadow:0 20px 40px -10px rgba(0,0,0,0.1); padding:30px 24px; }
    .login-card h2 { margin-top:0; color:var(--accent-color); font-size:1.5rem; text-align:center; margin-bottom: 20px; }
    
    input, textarea, select { 
      width:100%; padding:12px; border-radius:12px; border:1px solid #cbd5e1; 
      margin-bottom:12px; font-size:16px; /* Evita zoom en iOS */
      font-family:inherit; background: #fff;
      appearance: none;
    }
    input:focus, textarea:focus { outline:none; border-color:var(--accent-color); ring: 2px var(--accent-soft); }

    .primary-btn { 
      width:100%; padding:14px; border-radius:12px; border:none; 
      background:var(--accent-color); color:white; font-weight:600; font-size:1rem; 
      cursor:pointer; transition:0.2s; box-shadow: 0 4px 6px -1px rgba(124, 58, 237, 0.3);
    }
    .primary-btn:active { transform: scale(0.98); }

    /* --- APP LAYOUT --- */
    .app { max-width: 1000px; margin: 0 auto; padding: 10px; }

    /* TOPBAR RESPONSIVE */
    .topbar { 
      background: #fff; border-radius: var(--card-radius); padding: 12px 16px; 
      margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;
    }
    
    .brand { display: flex; align-items: center; gap: 8px; }
    .brand-text { font-weight: 700; font-size: 1.1rem; }
    
    .user-controls { display: flex; align-items: center; gap: 8px; }
    
    #user-role-label { 
      background: #f1f5f9; padding: 4px 10px; border-radius: 20px; 
      font-size: 0.8rem; font-weight: 600; color: #475569; 
    }
    
    #logout-btn { 
      padding: 6px 12px; border-radius: 20px; border: 1px solid #e2e8f0; 
      background: #fff; color: #ef4444; font-size: 0.8rem; font-weight: 600;
    }

    /* GRID PRINCIPAL */
    .layout { 
      display: grid; grid-template-columns: 2fr 1fr; gap: 12px; 
    }

    /* CALENDARIO */
    .calendar-wrapper { 
      background: #fff; border-radius: var(--card-radius); padding: 16px; 
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
    }
    
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .nav-btn { background: #f8fafc; border: 1px solid #e2e8f0; width: 36px; height: 36px; border-radius: 50%; display: grid; place-items: center; font-size: 1.2rem; cursor: pointer; }
    #calendar-title { margin: 0; font-size: 1.1rem; text-transform: capitalize; }

    .month-table { width: 100%; border-collapse: separate; border-spacing: 3px; table-layout: fixed; }
    .month-table th { font-size: 0.75rem; color: #94a3b8; padding-bottom: 4px; }
    .month-table td { 
      height: 60px; position: relative; border-radius: 10px; 
      vertical-align: top; cursor: default; transition: 0.2s;
    }
    
    .day-mother { background: var(--mother-color); color: var(--mother-text); border: 1px solid rgba(255,255,255,0.5); }
    .day-father { background: var(--father-color); color: var(--father-text); border: 1px solid rgba(255,255,255,0.5); }
    
    .day-number { position: absolute; top: 4px; left: 6px; font-size: 0.8rem; font-weight: 700; z-index: 2; }
    .owner-icon { 
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
      font-size: 1.8rem; opacity: 0.3; pointer-events: none; z-index: 1; filter: grayscale(10%); 
    }
    .day-overridden::after { content: "‚áÑ"; position: absolute; top: 2px; right: 4px; font-size: 0.7rem; opacity: 0.8; z-index: 3; }
    .today-marker { position: absolute; bottom: 4px; right: 4px; width: 6px; height: 6px; background: var(--accent-color); border-radius: 50%; z-index: 3; box-shadow: 0 0 0 2px white; }

    /* PANELES LATERALES */
    .card { background: #fff; border-radius: var(--card-radius); padding: 16px; margin-bottom: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    .panel-title { margin: 0 0 12px 0; font-size: 1rem; font-weight: 700; color: #334155; display: flex; align-items: center; gap: 6px; }

    .requests-list { max-height: 300px; overflow-y: auto; }
    .request-item { 
      padding: 12px; border: 1px solid #f1f5f9; border-radius: 12px; margin-bottom: 8px; 
      background: #f8fafc; font-size: 0.85rem; 
    }
    .req-header { display: flex; justify-content: space-between; margin-bottom: 4px; color: #64748b; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
    .req-dates { font-weight: 700; color: #0f172a; margin-bottom: 4px; font-size: 0.9rem; }
    .req-reason { background: #fff; padding: 6px 10px; border-radius: 6px; font-style: italic; color: #475569; border: 1px dashed #cbd5e1; }

    /* ESTADO PILL */
    .status-pill { padding: 2px 8px; border-radius: 99px; font-size: 0.7rem; font-weight: 700; }
    .st-aceptado { background: #dcfce7; color: #166534; }
    .st-rechazado { background: #fee2e2; color: #991b1b; }
    .st-pendiente { background: #fef3c7; color: #92400e; }

    /* ========== RESPONSIVE MOBILE FIXES ========== */
    @media (max-width: 768px) {
      .app { padding: 8px; }
      
      /* Cambiar grid a una sola columna */
      .layout { grid-template-columns: 1fr; gap: 16px; }
      
      /* Topbar apilada en m√≥viles muy estrechos */
      .topbar { padding: 12px; }
      .brand { flex-grow: 1; }
      
      /* Ajustar calendario para dedos */
      .calendar-wrapper { padding: 12px 10px; }
      .month-table td { height: 48px; border-radius: 8px; }
      .owner-icon { font-size: 1.4rem; }
      .day-number { font-size: 0.75rem; top: 2px; left: 4px; }
      
      /* Inputs m√°s grandes y en columna */
      .date-group { flex-direction: column; }
      .date-group input { width: 100%; }
      
      /* Ajustes de tarjeta */
      .card { padding: 14px; }
    }
    
    @media (max-width: 400px) {
      .topbar { flex-direction: column; align-items: flex-start; }
      .user-controls { width: 100%; justify-content: space-between; margin-top: 8px; }
      #year-select { padding: 8px; }
    }
  </style>
</head>
<body>

<div class="toast-container" id="toast-container"></div>

<div id="login-view" class="login-wrapper">
  <div class="login-card">
    <h2>üìÖ Custodia</h2>
    <form id="login-form">
      <label style="font-size:0.9rem; font-weight:600; color:#475569;">Email</label>
      <input type="email" id="login-email" required placeholder="tu@email.com">
      
      <label style="font-size:0.9rem; font-weight:600; color:#475569;">Contrase√±a</label>
      <input type="password" id="login-password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      
      <button type="submit" class="primary-btn" id="login-submit-btn">Entrar</button>
      <p id="login-error" style="color:#ef4444; text-align:center; margin-top:12px; font-size:0.9rem; min-height:1rem;"></p>
    </form>
  </div>
</div>

<div id="app-root" class="app hidden">
  <header class="topbar">
    <div class="brand">
      <span style="font-size:1.6rem;">üóìÔ∏è</span>
      <span class="brand-text">Custodia Familiar</span>
    </div>
    <div class="user-controls">
      <select id="year-select" style="width:auto; margin:0; padding:6px 24px 6px 10px; font-size:0.9rem;"></select>
      <span id="user-role-label">...</span>
      <button id="logout-btn">Salir</button>
    </div>
  </header>

  <div class="layout">
    <section class="calendar-wrapper">
      <div class="calendar-header">
        <button id="prev-period" class="nav-btn">‚Äπ</button>
        <h2 id="calendar-title"></h2>
        <button id="next-period" class="nav-btn">‚Ä∫</button>
      </div>
      <div id="calendar-grid"></div>
    </section>

    <section class="side-panel">
      
      <div class="card">
        <div class="panel-title">‚ûï Solicitar cambio</div>
        <form id="request-form">
          <div class="date-group" style="display:flex; gap:8px; margin-bottom:10px;">
            <div style="flex:1;">
              <label style="font-size:0.8rem; color:#64748b;">Desde</label>
              <input type="date" id="start-date" required style="margin:0;">
            </div>
            <div style="flex:1;">
              <label style="font-size:0.8rem; color:#64748b;">Hasta</label>
              <input type="date" id="end-date" required style="margin:0;">
            </div>
          </div>
          <label style="font-size:0.8rem; color:#64748b;">Motivo</label>
          <textarea id="reason" required placeholder="Ej: Viaje de trabajo..." style="min-height:60px; margin-bottom:10px;"></textarea>
          <button type="submit" class="primary-btn">Enviar Solicitud</button>
        </form>
      </div>

      <div class="card">
        <div class="panel-title">‚è≥ Pendientes</div>
        <div class="requests-list" id="pending-requests"></div>
      </div>

      <div class="card">
        <div class="panel-title">üìú Historial</div>
        <div class="requests-list" id="history-requests"></div>
      </div>
    </section>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
  // === 1. CONFIGURACI√ìN FIREBASE ===
  const firebaseConfig = {
    apiKey: "AIzaSyAwgk4_l0zvaCUCgm1CjqqqXjJHr5KPBjc",
    authDomain: "custodia-familiar.firebaseapp.com",
    projectId: "custodia-familiar",
    storageBucket: "custodia-familiar.firebasestorage.app",
    messagingSenderId: "1038952432258",
    appId: "1:1038952432258:web:7608d6a48d8ad8308a6a9b"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  // === 2. VARIABLES ===
  const MIN_YEAR = 2026; const MAX_YEAR = 2027;
  let currentYear = 2026; let currentMonth = 0;
  let currentUser = null; let currentRole = null;
  let overrides = {}; let pendingRequests = []; let historyRequests = [];
  const monthNames = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
  
  // LOGICA SEMANA 1 (5 Enero 2026) => PADRE
  const BASE_MONDAY = new Date(2026, 0, 5, 12, 0, 0); 

  // === 3. UI HELPERS ===
  function showToast(msg, type='success') {
    const c = document.getElementById('toast-container');
    const el = document.createElement('div'); el.className = `toast ${type}`; el.innerText = msg;
    c.appendChild(el); requestAnimationFrame(()=>el.classList.add('visible'));
    setTimeout(()=>{ el.classList.remove('visible'); setTimeout(()=>el.remove(),300); }, 3000);
  }

  // === 4. L√ìGICA DE CALENDARIO ===
  function formatDateKey(y, m, d) { return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }

  function getBaseOwner(year, monthIndex, day) {
    const date = new Date(year, monthIndex, day, 12, 0, 0);
    if (date.getFullYear() < MIN_YEAR || date.getFullYear() > MAX_YEAR) return null;
    const diffMs = date - BASE_MONDAY;
    const diffDays = Math.round(diffMs / 86400000);
    const weekIndex = Math.floor(diffDays / 7);
    
    // Semana 0 (5-11 Ene) es PAR. Queremos que PAR sea PADRE.
    const isEven = Math.abs(weekIndex) % 2 === 0;
    return isEven ? "padre" : "madre";
  }

  function renderCalendar() {
    const grid = document.getElementById("calendar-grid");
    document.getElementById("calendar-title").innerText = `${monthNames[currentMonth]} ${currentYear}`;
    grid.innerHTML = "";
    
    const table = document.createElement("table"); table.className = "month-table";
    table.innerHTML = `<thead><tr><th>L</th><th>M</th><th>X</th><th>J</th><th>V</th><th>S</th><th>D</th></tr></thead>`;
    const tbody = document.createElement("tbody");
    
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    let startDay = new Date(currentYear, currentMonth, 1).getDay();
    startDay = (startDay === 0) ? 6 : startDay - 1;

    let dayCounter = 1; let finished = false;
    while (!finished) {
      const tr = document.createElement("tr");
      for (let i=0; i<7; i++) {
        const td = document.createElement("td");
        if (dayCounter <= daysInMonth && (dayCounter > 1 || i >= startDay)) {
          const key = formatDateKey(currentYear, currentMonth, dayCounter);
          const owner = overrides[key] || getBaseOwner(currentYear, currentMonth, dayCounter);
          
          td.className = owner === "padre" ? "day-father" : "day-mother";
          if (overrides[key]) td.classList.add("day-overridden");
          
          // Marca de Hoy
          const today = new Date();
          let todayMark = "";
          if(currentYear===today.getFullYear() && currentMonth===today.getMonth() && dayCounter===today.getDate()){
            todayMark = '<div class="today-marker"></div>';
          }

          td.innerHTML = `
            <span class="day-number">${dayCounter}</span>
            <div class="owner-icon">${owner === "madre" ? "üë©" : "üë®"}</div>
            ${todayMark}
          `;
          dayCounter++;
        } else { td.style.background = "transparent"; }
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
      if (dayCounter > daysInMonth) finished = true;
    }
    table.appendChild(tbody); grid.appendChild(table);
  }

  // === 5. RENDERIZADO DE LISTAS ===
  function renderLists() {
    const pEl = document.getElementById("pending-requests");
    const hEl = document.getElementById("history-requests");
    pEl.innerHTML = ""; hEl.innerHTML = "";

    if(pendingRequests.length === 0) pEl.innerHTML = "<div style='color:#94a3b8;font-style:italic;padding:5px;'>No hay pendientes</div>";
    
    pendingRequests.forEach(req => {
      pEl.innerHTML += `
        <div class="request-item" style="border-left:4px solid #f59e0b;">
          <div class="req-dates">${req.startDate} ‚ûî ${req.endDate}</div>
          <div class="req-reason">"${req.reason}"</div>
          <div style="margin-top:4px; font-size:0.75rem; color:#64748b;">
            Solicita: <strong>${req.requesterRole.toUpperCase()}</strong>
          </div>
        </div>`;
    });

    if(historyRequests.length === 0) hEl.innerHTML = "<div style='color:#94a3b8;font-style:italic;padding:5px;'>Sin historial</div>";
    
    historyRequests.forEach(req => {
      const stClass = req.status === 'aceptado' ? 'st-aceptado' : 'st-rechazado';
      const icon = req.status === 'aceptado' ? '‚úÖ' : '‚ùå';
      
      hEl.innerHTML += `
        <div class="request-item">
          <div class="req-header">
             <span>${req.requesterRole}</span>
             <span class="status-pill ${stClass}">${icon} ${req.status}</span>
          </div>
          <div class="req-dates">${req.startDate} ‚ûî ${req.endDate}</div>
          <div class="req-reason">${req.reason}</div>
        </div>`;
    });
  }

  // === 6. AUTENTICACI√ìN Y EVENTOS ===
  document.getElementById("login-form").onsubmit = (e) => {
    e.preventDefault();
    const btn = document.getElementById("login-submit-btn");
    btn.textContent = "Verificando..."; btn.disabled = true;
    auth.signInWithEmailAndPassword(document.getElementById("login-email").value, document.getElementById("login-password").value)
      .catch(err => {
        document.getElementById("login-error").innerText = "Email o contrase√±a incorrectos";
        btn.textContent = "Entrar"; btn.disabled = false;
      });
  };
  
  document.getElementById("logout-btn").onclick = () => auth.signOut();

  auth.onAuthStateChanged(async (user) => {
    if(user) {
      const snap = await db.collection("users").doc(user.uid).get();
      if(snap.exists) {
        currentRole = snap.data().role;
        document.getElementById("user-role-label").innerText = currentRole === "padre" ? "üë® Padre" : "üë© Madre";
        document.getElementById("login-view").classList.add("hidden");
        document.getElementById("app-root").classList.remove("hidden");
        initData();
      } else { alert("Usuario sin rol configurado."); auth.signOut(); }
    } else {
      document.getElementById("login-view").classList.remove("hidden");
      document.getElementById("app-root").classList.add("hidden");
      document.getElementById("login-submit-btn").textContent = "Entrar";
      document.getElementById("login-submit-btn").disabled = false;
    }
  });

  function initData() {
    renderCalendar();
    db.collection("overrides").onSnapshot(s => { overrides={}; s.forEach(d=>overrides[d.id]=d.data().owner); renderCalendar(); });
    db.collection("requests").orderBy("createdAt", "desc").onSnapshot(s => {
      pendingRequests=[]; historyRequests=[];
      s.forEach(d => {
        const item = {id:d.id, ...d.data()};
        if(item.status==="pendiente") pendingRequests.push(item); else historyRequests.push(item);
      });
      renderLists();
    });
  }

  // === 7. CONTROLES ===
  document.getElementById("prev-period").onclick = () => { currentMonth--; if(currentMonth<0){currentMonth=11;currentYear--;} updateYearSelect(); renderCalendar(); };
  document.getElementById("next-period").onclick = () => { currentMonth++; if(currentMonth>11){currentMonth=0;currentYear++;} updateYearSelect(); renderCalendar(); };
  
  const yearSel = document.getElementById("year-select");
  [2026, 2027].forEach(y => { const o=document.createElement("option"); o.value=y; o.text=y; yearSel.add(o); });
  yearSel.value = currentYear;
  yearSel.onchange = (e) => { currentYear = parseInt(e.target.value); renderCalendar(); };
  
  function updateYearSelect() { yearSel.value = currentYear; }

  document.getElementById("request-form").onsubmit = async (e) => {
    e.preventDefault();
    if(!currentRole) return;
    try {
      await db.collection("requests").add({
        requesterUid: auth.currentUser.uid, requesterRole: currentRole,
        startDate: document.getElementById("start-date").value,
        endDate: document.getElementById("end-date").value,
        reason: document.getElementById("reason").value,
        status: "pendiente",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      showToast("Solicitud enviada"); e.target.reset();
    } catch(e) { showToast("Error al enviar", "error"); }
  };
</script>
</body>
</html>
