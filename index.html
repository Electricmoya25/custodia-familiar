<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Custodia Familiar 2026-2027</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --father-color: #ffe4e4; /* rojo pastel muy suave */
      --mother-color: #e4ecff; /* azul pastel muy suave */
      --border-color: #e3e3ee;
      --accent-color: #7c3aed;   /* morado principal */
      --accent-soft: #ede9fe;
      --text-main: #111827;
      --text-muted: #6b7280;
      --bg-main: #f3f4fb;
      --card-bg: #ffffff;
      --shadow-soft: 0 16px 40px rgba(15, 23, 42, 0.12);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
    }

    h1, h2, h3 {
      margin-top: 0;
    }

    .hidden {
      display: none !important;
    }

    /* ========== LOGIN ========== */

    .login-wrapper {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      background: radial-gradient(circle at top, #ede9fe, #e5e7eb);
    }

    .login-card {
      background: #ffffff;
      max-width: 380px;
      width: 100%;
      border-radius: 20px;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.2);
      padding: 18px 18px 16px;
    }

    .login-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .login-title span.icon {
      font-size: 1.3rem;
    }

    .login-subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .login-field {
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .login-field label {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .login-field input {
      font-family: inherit;
      font-size: 0.85rem;
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      width: 100%;
    }

    .login-field input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 1px rgba(124, 58, 237, 0.3);
    }

    .login-btn {
      margin-top: 8px;
      width: 100%;
      justify-content: center;
    }

    .login-error {
      color: #b91c1c;
      font-size: 0.7rem;
      margin-top: 4px;
      min-height: 14px;
    }

    .login-hint {
      margin-top: 8px;
      font-size: 0.7rem;
      color: #6b7280;
    }

    /* ========== APP PRINCIPAL ========== */

    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px 12px 32px;
    }

    /* =================== TOPBAR =================== */

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      border-radius: 18px;
      background: #ffffff;
      box-shadow: 0 8px 25px rgba(15, 23, 42, 0.08);
      margin-bottom: 14px;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 28px;
      height: 28px;
      border-radius: 10px;
      background: var(--accent-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: var(--accent-color);
    }

    .app-name {
      font-weight: 600;
      font-size: 1rem;
      color: var(--text-main);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      margin-top: 2px;
      background: #fef3c7;
      color: #92400e;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #facc15;
      transition: background 0.2s ease;
    }

    .status-pill.status-connecting {
      background: #fef3c7;
      color: #92400e;
    }

    .status-pill.status-online {
      background: #dcfce7;
      color: #166534;
    }

    .status-pill.status-error {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-pill.status-online .status-dot {
      background: #22c55e;
    }

    .status-pill.status-error .status-dot {
      background: #ef4444;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .year-select {
      padding: 6px 16px 6px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      font-size: 0.8rem;
      font-family: inherit;
      outline: none;
      cursor: pointer;
      position: relative;
    }

    .year-select:focus {
      box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.25);
      border-color: var(--accent-color);
    }

    .user-info {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      background: #f9fafb;
      border-radius: 999px;
      padding: 4px 6px 4px 10px;
      border: 1px solid #e5e7eb;
    }

    .user-role-label {
      font-weight: 600;
    }

    .logout-btn {
      padding: 4px 9px;
      font-size: 0.72rem;
      background: #e5e7eb;
      color: #111827;
      border-radius: 999px;
      border: none;
      cursor: pointer;
    }

    @media (max-width: 800px) {
      .topbar {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .topbar-right {
        width: 100%;
        justify-content: space-between;
      }
    }

    @media (max-width: 480px) {
      .app {
        padding: 8px 8px 24px;
      }

      .topbar {
        padding: 8px 10px;
      }

      .app-name {
        font-size: 0.95rem;
      }

      .status-pill {
        font-size: 0.65rem;
      }
    }

    /* =================== LAYOUT PRINCIPAL =================== */

    .layout {
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-top: 2px;
    }

    /* =================== CALENDARIO =================== */

    .calendar-wrapper {
      background: var(--card-bg);
      border-radius: 26px;
      padding: 14px 14px 16px;
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    @media (max-width: 480px) {
      .calendar-wrapper {
        padding: 10px 10px 12px;
        border-radius: 20px;
      }
    }

    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .month-nav {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      justify-content: center;
    }

    .nav-arrow {
      border-radius: 999px;
      border: none;
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: #f9fafb;
      color: #6b7280;
      font-size: 16px;
      flex-shrink: 0;
    }

    .nav-arrow:hover {
      background: #e5e7eb;
    }

    .calendar-title {
      font-weight: 600;
      font-size: 1.02rem;
    }

    .calendar-title span.year {
      color: var(--accent-color);
    }

    @media (max-width: 480px) {
      .calendar-title {
        font-size: 0.95rem;
      }
    }

    .calendar-subheader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
      font-size: 0.76rem;
      color: var(--text-muted);
      flex-wrap: wrap;
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.06);
    }

    .legend-color.mother {
      background: var(--mother-color);
    }

    .legend-color.father {
      background: var(--father-color);
    }

    .calendar-controls {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      flex-wrap: wrap;
    }

    .calendar-controls label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .calendar-controls select {
      font-family: inherit;
      font-size: 0.74rem;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      outline: none;
    }

    .calendar-controls select:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 1px rgba(124, 58, 237, 0.25);
    }

    .calendar-grid {
      margin-top: 4px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 10px;
    }

    @media (max-width: 600px) {
      .calendar-grid {
        grid-template-columns: 1fr;
      }
    }

    .month {
      border-radius: 18px;
      background: #f9fafc;
      border: 1px solid rgba(229, 231, 235, 0.8);
      overflow: hidden;
    }

    .month-header {
      text-align: center;
      padding: 6px 6px 3px;
      font-weight: 600;
      font-size: 0.86rem;
      color: #4b5563;
    }

    .month-body {
      padding: 4px 8px 6px;
    }

    table.month-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 0.66rem;
    }

    .month-table th,
    .month-table td {
      border: none;
      text-align: center;
      vertical-align: top;
      height: 38px;
      position: relative;
      padding: 1px 1px;
    }

    .month-table th {
      font-size: 0.64rem;
      font-weight: 500;
      color: #9ca3af;
      padding-bottom: 4px;
    }

    .month-table td {
      border-radius: 10px;
    }

    .day-cell {
      cursor: default;
      transition: transform 0.05s ease, box-shadow 0.06s ease;
    }

    .day-cell:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.15);
    }

    .day-number {
      position: absolute;
      top: 3px;
      left: 5px;
      font-size: 0.65rem;
      font-weight: 600;
      color: #4b5563;
    }

    .owner-pill {
      position: absolute;
      bottom: 3px;
      left: 50%;
      transform: translateX(-50%);
      padding: 1px 7px;
      border-radius: 999px;
      font-size: 0.6rem;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(255, 255, 255, 0.8);
    }

    .owner-pill.madre-pill {
      color: #4c6fff;
      border-color: rgba(129, 140, 248, 0.8);
      background: rgba(239, 246, 255, 0.95);
    }

    .owner-pill.padre-pill {
      color: #f97373;
      border-color: rgba(248, 113, 113, 0.85);
      background: rgba(254, 242, 242, 0.95);
    }

    .day-father {
      background: var(--father-color);
      background-image: linear-gradient(135deg, rgba(255, 255, 255, 0.82), transparent);
      box-shadow: inset 0 0 4px rgba(248, 113, 113, 0.2);
    }

    .day-mother {
      background: var(--mother-color);
      background-image: linear-gradient(135deg, rgba(255, 255, 255, 0.85), transparent);
      box-shadow: inset 0 0 4px rgba(129, 140, 248, 0.18);
    }

    .day-outside {
      background: transparent;
      color: transparent;
    }

    .day-overridden::after {
      content: "‚áÑ";
      position: absolute;
      top: 3px;
      right: 5px;
      font-size: 0.68rem;
      opacity: 0.85;
      color: #6b7280;
    }

    /* =================== PANEL DEBAJO =================== */

    .side-panel {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 12px;
    }

    @media (max-width: 900px) {
      .side-panel {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: 22px;
      padding: 10px 12px 12px;
      box-shadow: var(--shadow-soft);
    }

    .new-request-card {
      padding: 0;
      overflow: hidden;
    }

    .new-request-header {
      background: var(--accent-color);
      color: #ffffff;
      border-radius: 22px 22px 0 0;
      padding: 8px 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .new-request-header span.icon {
      font-size: 1rem;
    }

    .new-request-body {
      padding: 8px 12px 12px;
      background: #f9fafb;
    }

    .card h3 {
      font-size: 0.9rem;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card h3::before {
      content: "";
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #e5e7eb;
    }

    .card h3.highlight::before {
      background: #facc15;
    }

    .field-group {
      margin-bottom: 7px;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    label {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    input[type="date"],
    textarea {
      font-family: inherit;
      font-size: 0.78rem;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      width: 100%;
      background: #ffffff;
    }

    input[type="date"]:focus,
    textarea:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 1px rgba(124, 58, 237, 0.25);
    }

    textarea {
      resize: vertical;
      min-height: 55px;
    }

    button {
      font-family: inherit;
      font-size: 0.78rem;
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      cursor: pointer;
      background: var(--accent-color);
      color: #fff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }

    button.small {
      padding: 4px 9px;
      font-size: 0.72rem;
    }

    button:disabled {
      opacity: 0.65;
      cursor: not-allowed;
    }

    .requests-section {
      font-size: 0.76rem;
      max-height: 220px;
      overflow-y: auto;
      padding-right: 4px;
      margin-top: 3px;
    }

    .request-item {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      margin-bottom: 6px;
      background: #f9fafb;
    }

    .request-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
      gap: 6px;
    }

    .request-parties {
      font-weight: 600;
      font-size: 0.8rem;
    }

    .request-dates {
      font-size: 0.74rem;
      color: var(--text-muted);
    }

    .request-reason {
      margin-top: 2px;
      font-size: 0.74rem;
      color: #374151;
    }

    .request-actions {
      margin-top: 4px;
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    .status-pill-mini {
      display: inline-flex;
      align-items: center;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 0.68rem;
      font-weight: 600;
    }

    .status-pendiente {
      background: #fef3c7;
      color: #92400e;
    }

    .status-aceptado {
      background: #dcfce7;
      color: #166534;
    }

    .status-rechazado {
      background: #fee2e2;
      color: #991b1b;
    }

    .empty-text {
      font-size: 0.74rem;
      color: #9ca3af;
      font-style: italic;
      padding: 4px 0;
    }

    .helper-text {
      font-size: 0.7rem;
      color: #9ca3af;
    }

    .whoami-label {
      font-size: 0.8rem;
      font-weight: 500;
      color: #4b5563;
    }
  </style>
</head>
<body>

<!-- VISTA LOGIN -->
<div id="login-view" class="login-wrapper">
  <div class="login-card">
    <div class="login-title">
      <span class="icon">üîê</span>
      <span>Acceso a Custodia Familiar</span>
    </div>
    <p class="login-subtitle">
      Introduce tu correo y contrase√±a de Firebase. Cada progenitor tiene su propio usuario.
    </p>

    <form id="login-form">
      <div class="login-field">
        <label for="login-email">Correo electr√≥nico</label>
        <input type="email" id="login-email" required autocomplete="email">
      </div>
      <div class="login-field">
        <label for="login-password">Contrase√±a</label>
        <input type="password" id="login-password" required autocomplete="current-password">
      </div>
      <button type="submit" class="login-btn">
        Entrar
      </button>
      <p id="login-error" class="login-error"></p>
    </form>

    <p class="login-hint">
      Configura las cuentas en Firebase Authentication (Email/Password) y asigna el rol
      <strong>"padre"</strong> o <strong>"madre"</strong> en la colecci√≥n <code>users</code>.
    </p>
  </div>
</div>

<!-- APP -->
<div id="app-root" class="app hidden">
  <!-- TOPBAR -->
  <header class="topbar">
    <div class="topbar-left">
      <div class="logo-icon">üìÖ</div>
      <div>
        <div class="app-name">Custodia Familiar</div>
        <div class="status-pill status-connecting">
          <span class="status-dot"></span>
          <span id="status-text">Conectando‚Ä¶</span>
        </div>
      </div>
    </div>
    <div class="topbar-right">
      <select id="year-select" class="year-select"></select>
      <div class="user-info">
        <span class="user-role-label" id="user-role-label">Sin identificar</span>
        <button type="button" id="logout-btn" class="logout-btn">Salir</button>
      </div>
    </div>
  </header>

  <div class="layout">
    <!-- CALENDARIO -->
    <section class="calendar-wrapper">
      <div class="calendar-header">
        <button id="prev-period" class="nav-arrow" title="Anterior">‚Äπ</button>
        <div class="month-nav">
          <div class="calendar-title" id="calendar-title"></div>
        </div>
        <button id="next-period" class="nav-arrow" title="Siguiente">‚Ä∫</button>
      </div>

      <div class="calendar-subheader">
        <div class="legend">
          <span class="legend-item">
            <span class="legend-color mother"></span> Madre
          </span>
          <span class="legend-item">
            <span class="legend-color father"></span> Padre
          </span>
          <span class="legend-item">‚áÑ d√≠a modificado</span>
        </div>
        <div class="calendar-controls">
          <label>
            Vista
            <select id="view-mode">
              <option value="month">Mes</option>
              <option value="year">A√±o completo</option>
            </select>
          </label>
          <label id="month-select-wrapper">
            Mes
            <select id="month-select">
              <option value="0">Enero</option>
              <option value="1">Febrero</option>
              <option value="2">Marzo</option>
              <option value="3">Abril</option>
              <option value="4">Mayo</option>
              <option value="5">Junio</option>
              <option value="6">Julio</option>
              <option value="7">Agosto</option>
              <option value="8">Septiembre</option>
              <option value="9">Octubre</option>
              <option value="10">Noviembre</option>
              <option value="11">Diciembre</option>
            </select>
          </label>
        </div>
      </div>

      <div id="calendar-grid" class="calendar-grid"></div>
    </section>

    <!-- PANEL SOLICITUDES -->
    <section class="side-panel">
      <!-- Nueva solicitud -->
      <section class="card new-request-card">
        <div class="new-request-header">
          <span class="icon">‚ûï</span>
          <span> Nueva solicitud</span>
        </div>
        <div class="new-request-body">
          <form id="request-form">
            <div class="field-group">
              <label>¬øQui√©n solicita el cambio?</label>
              <span id="whoami-label" class="whoami-label">No identificado</span>
            </div>

            <div class="field-group">
              <label>Rango de fechas (entre 2026 y 2027)</label>
              <div style="display:flex; gap:6px;">
                <input type="date" id="start-date" required>
                <input type="date" id="end-date" required>
              </div>
              <div class="helper-text">
                La custodia para esos d√≠as pasar√° al progenitor solicitante si el otro acepta.
              </div>
            </div>

            <div class="field-group">
              <label for="reason">Motivo del cambio</label>
              <textarea id="reason" placeholder="Ej: Viaje de trabajo, evento familiar, vacaciones..." required></textarea>
            </div>

            <button type="submit">
              Crear solicitud
            </button>
          </form>
        </div>
      </section>

      <!-- Pendientes + Historial -->
      <div style="display:flex; flex-direction:column; gap:12px;">
        <!-- Pendientes -->
        <section class="card">
          <h3 class="highlight">Solicitudes pendientes</h3>
          <div class="requests-section" id="pending-requests"></div>
          <p class="helper-text">
            Solo podr√°s aceptar/rechazar las solicitudes donde t√∫ seas el destinatario.
          </p>
        </section>

        <!-- Historial -->
        <section class="card">
          <h3>Historial</h3>
          <div class="requests-section" id="history-requests"></div>
        </section>
      </div>
    </section>
  </div>
</div>

<!-- Firebase compat (v9) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
  // =================== CONFIGURACI√ìN FIREBASE ===================
  const firebaseConfig = {
    apiKey: "PEGAR_AQUI_TU_API_KEY",
    authDomain: "PEGAR_AQUI_TU_AUTH_DOMAIN",
    projectId: "PEGAR_AQUI_TU_PROJECT_ID",
    storageBucket: "PEGAR_AQUI_TU_STORAGE_BUCKET",
    messagingSenderId: "PEGAR_AQUI_TU_SENDER_ID",
    appId: "PEGAR_AQUI_TU_APP_ID"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
</script>

<script>
  // ================= CONFIGURACI√ìN B√ÅSICA =================

  const MIN_YEAR = 2026;
  const MAX_YEAR = 2027;
  const GLOBAL_MIN_DATE = `${MIN_YEAR}-01-01`;
  const GLOBAL_MAX_DATE = `${MAX_YEAR}-12-31`;

  let currentYear = 2026;
  let currentView = "month";
  let currentMonth = 0;

  const monthNames = [
    "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
    "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
  ];

  const weekDayNames = ["Lun", "Mar", "Mi√©", "Jue", "Vie", "S√°b", "Dom"];

  let overrides = {};
  let pendingRequests = [];
  let historyRequests = [];

  let currentUser = null;       // usuario Firebase
  let currentRole = null;       // "padre" o "madre"

  const statusPill = document.querySelector(".status-pill");
  const statusText = document.getElementById("status-text");

  function setConnectionStatus(state) {
    statusPill.classList.remove("status-connecting", "status-online", "status-error");
    statusPill.classList.add("status-" + state);

    if (state === "connecting") {
      statusText.textContent = "Conectando‚Ä¶";
    } else if (state === "online") {
      statusText.textContent = "Conectado";
    } else if (state === "error") {
      statusText.textContent = "Error de conexi√≥n";
    }
  }

  setConnectionStatus("connecting");

  function updateUserUI() {
    const roleLabel = document.getElementById("user-role-label");
    const whoLabel = document.getElementById("whoami-label");

    if (!currentUser || !currentRole) {
      if (roleLabel) roleLabel.textContent = "Sin identificar";
      if (whoLabel) whoLabel.textContent = "No identificado";
      return;
    }

    const texto = currentRole === "padre" ? "Padre" : "Madre";
    if (roleLabel) roleLabel.textContent = texto;
    if (whoLabel) whoLabel.textContent = "Est√°s identificado como: " + texto;
  }

  // ================= UTILIDADES DE FECHA =================

  function parseDateStr(str) {
    const [y, m, d] = str.split("-").map(Number);
    return new Date(y, m - 1, d);
  }

  function clampToRange(date) {
    const min = parseDateStr(GLOBAL_MIN_DATE).getTime();
    const max = parseDateStr(GLOBAL_MAX_DATE).getTime();
    const t = Math.min(Math.max(date.getTime(), min), max);
    return new Date(t);
  }

  function formatDateKey(year, monthIndex, day) {
    const m = String(monthIndex + 1).padStart(2, "0");
    const d = String(day).padStart(2, "0");
    return `${year}-${m}-${d}`;
  }

  function getCycleStartMonday(year) {
    const jan1 = new Date(year, 0, 1);
    const day = jan1.getDay();
    let diff;
    if (day === 1) diff = 0;
    else if (day === 0) diff = -6;
    else diff = 1 - day;
    jan1.setDate(jan1.getDate() + diff);
    return jan1;
  }

  function getBaseOwner(year, monthIndex, day) {
    if (year < MIN_YEAR || year > MAX_YEAR) return null;
    const date = new Date(year, monthIndex, day);
    const startMonday = getCycleStartMonday(year);
    const diffMs = date - startMonday;
    const diffDays = Math.floor(diffMs / 86400000);
    const weekIndex = Math.floor(diffDays / 7);
    // Semana 1 del a√±o (empezando lunes): MADRE
    // Semana 2: PADRE
    return weekIndex % 2 === 0 ? "madre" : "padre";
  }

  // ================= RENDER DEL CALENDARIO =================

  function renderCalendar() {
    const grid = document.getElementById("calendar-grid");
    if (!grid) return;
    grid.innerHTML = "";

    const titleEl = document.getElementById("calendar-title");
    if (currentView === "year") {
      titleEl.innerHTML = `A√±o <span class="year">${currentYear}</span>`;
    } else {
      titleEl.innerHTML = `${monthNames[currentMonth]} <span class="year">${currentYear}</span>`;
    }

    const monthsToRender = currentView === "year" ? [...Array(12).keys()] : [currentMonth];

    monthsToRender.forEach((monthIndex) => {
      const monthDiv = document.createElement("div");
      monthDiv.className = "month";

      const header = document.createElement("div");
      header.className = "month-header";
      header.textContent = `${monthNames[monthIndex]} ${currentYear}`;
      monthDiv.appendChild(header);

      const body = document.createElement("div");
      body.className = "month-body";

      const table = document.createElement("table");
      table.className = "month-table";

      const thead = document.createElement("thead");
      const headRow = document.createElement("tr");
      weekDayNames.forEach((d) => {
        const th = document.createElement("th");
        th.textContent = d;
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      table.appendChild(thead);

      const year = currentYear;
      const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
      const firstDay = new Date(year, monthIndex, 1);
      let dayOfWeek = firstDay.getDay();
      dayOfWeek = (dayOfWeek + 6) % 7;

      const tbody = document.createElement("tbody");
      let currentDay = 1;
      let done = false;

      while (!done) {
        const row = document.createElement("tr");

        for (let col = 0; col < 7; col++) {
          const cell = document.createElement("td");

          if ((currentDay === 1 && col < dayOfWeek) || currentDay > daysInMonth) {
            cell.classList.add("day-outside");
          } else {
            const day = currentDay;
            const dateKey = formatDateKey(year, monthIndex, day);

            const baseOwner = getBaseOwner(year, monthIndex, day);
            const finalOwner = overrides[dateKey] || baseOwner;

            cell.classList.add("day-cell");
            if (finalOwner === "padre") {
              cell.classList.add("day-father");
            } else if (finalOwner === "madre") {
              cell.classList.add("day-mother");
            }

            if (overrides[dateKey]) {
              cell.classList.add("day-overridden");
            }

            const numSpan = document.createElement("span");
            numSpan.className = "day-number";
            numSpan.textContent = String(day);
            cell.appendChild(numSpan);

            const ownerSpan = document.createElement("span");
            ownerSpan.className =
              "owner-pill " + (finalOwner === "madre" ? "madre-pill" : "padre-pill");
            ownerSpan.textContent = finalOwner === "padre" ? "PADRE" : "MADRE";
            cell.appendChild(ownerSpan);

            cell.title = `${dateKey} ‚Ä¢ Custodia: ${
              finalOwner === "padre" ? "Padre" : "Madre"
            }`;

            currentDay++;
          }

          row.appendChild(cell);
        }

        tbody.appendChild(row);

        if (currentDay > daysInMonth) {
          done = true;
        }
      }

      table.appendChild(tbody);
      body.appendChild(table);
      monthDiv.appendChild(body);
      grid.appendChild(monthDiv);
    });
  }

  // ================= SOLICITUDES (Firestore) =================

  function addRequest(requester, startDateStr, endDateStr, reason) {
    const target = requester === "padre" ? "madre" : "padre";

    db.collection("requests")
      .add({
        requester,
        target,
        startDate: startDateStr,
        endDate: endDateStr,
        reason,
        status: "pendiente",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .catch((err) => {
        console.error("Error al crear la solicitud:", err);
        alert("Error al guardar la solicitud en la nube.");
        setConnectionStatus("error");
      });
  }

  function acceptRequest(req) {
    // Solo debe aceptar el progenitor destinatario (target)
    if (!currentRole || req.target !== currentRole) {
      alert("No puedes aceptar esta solicitud: pertenece al otro progenitor.");
      return;
    }

    db.collection("requests")
      .doc(req.id)
      .update({ status: "aceptado" })
      .then(() => {
        applyOverrideForRequest(req);
      })
      .catch((err) => {
        console.error("Error al aceptar solicitud:", err);
        alert("No se ha podido aceptar la solicitud.");
        setConnectionStatus("error");
      });
  }

  function rejectRequest(req) {
    if (!currentRole || req.target !== currentRole) {
      alert("No puedes rechazar esta solicitud: pertenece al otro progenitor.");
      return;
    }

    db.collection("requests")
      .doc(req.id)
      .update({ status: "rechazado" })
      .catch((err) => {
        console.error("Error al rechazar solicitud:", err);
        alert("No se ha podido rechazar la solicitud.");
        setConnectionStatus("error");
      });
  }

  function applyOverrideForRequest(req) {
    const { requester, startDate, endDate } = req;
    const start = clampToRange(parseDateStr(startDate));
    const end = clampToRange(parseDateStr(endDate));

    let current = new Date(start.getTime());
    const batch = db.batch();

    while (current.getTime() <= end.getTime()) {
      const year = current.getFullYear();
      if (year >= MIN_YEAR && year <= MAX_YEAR) {
        const key = formatDateKey(
          current.getFullYear(),
          current.getMonth(),
          current.getDate()
        );
        const ref = db.collection("overrides").doc(key);
        batch.set(ref, { owner: requester });
      }
      current.setDate(current.getDate() + 1);
    }

    batch
      .commit()
      .catch((err) => {
        console.error("Error al aplicar overrides:", err);
        alert("Los cambios se han aceptado, pero hubo un problema al guardarlos.");
        setConnectionStatus("error");
      });
  }

  // ================= LISTAS DE SOLICITUDES =================

  function renderRequests() {
    const pendingContainer = document.getElementById("pending-requests");
    const historyContainer = document.getElementById("history-requests");
    if (!pendingContainer || !historyContainer) return;

    pendingContainer.innerHTML = "";
    if (pendingRequests.length === 0) {
      const p = document.createElement("p");
      p.className = "empty-text";
      p.textContent = "No tienes solicitudes nuevas.";
      pendingContainer.appendChild(p);
    } else {
      pendingRequests.forEach((req) => {
        pendingContainer.appendChild(createRequestElement(req, true));
      });
    }

    historyContainer.innerHTML = "";
    if (historyRequests.length === 0) {
      const p = document.createElement("p");
      p.className = "empty-text";
      p.textContent = "Sin actividad.";
      historyContainer.appendChild(p);
    } else {
      historyRequests.forEach((req) => {
        historyContainer.appendChild(createRequestElement(req, false));
      });
    }
  }

  function createRequestElement(req, isPendingList) {
    const container = document.createElement("div");
    container.className = "request-item";

    const header = document.createElement("div");
    header.className = "request-header";

    const parties = document.createElement("div");
    parties.className = "request-parties";
    const requesterName = req.requester === "padre" ? "Padre" : "Madre";
    const targetName = req.target === "padre" ? "Padre" : "Madre";
    parties.textContent = `${requesterName} ‚Üí ${targetName}`;

    const status = document.createElement("span");
    status.className =
      "status-pill-mini " +
      (req.status === "pendiente"
        ? "status-pendiente"
        : req.status === "aceptado"
        ? "status-aceptado"
        : "status-rechazado");
    status.textContent =
      req.status === "pendiente"
        ? "Pendiente"
        : req.status === "aceptado"
        ? "Aceptado"
        : "Rechazado";

    header.appendChild(parties);
    header.appendChild(status);

    const dates = document.createElement("div");
    dates.className = "request-dates";
    dates.textContent = `${req.startDate} a ${req.endDate}`;

    const reason = document.createElement("div");
    reason.className = "request-reason";
    reason.textContent = `Motivo: ${req.reason}`;

    container.appendChild(header);
    container.appendChild(dates);
    container.appendChild(reason);

    if (isPendingList) {
      const actions = document.createElement("div");
      actions.className = "request-actions";

      // Solo mostramos botones si el usuario actual ES el target de esa solicitud
      if (currentRole && req.target === currentRole) {
        const acceptBtn = document.createElement("button");
        acceptBtn.type = "button";
        acceptBtn.className = "small";
        acceptBtn.textContent = "Aceptar";
        acceptBtn.addEventListener("click", () => acceptRequest(req));

        const rejectBtn = document.createElement("button");
        rejectBtn.type = "button";
        rejectBtn.className = "small secondary";
        rejectBtn.textContent = "Rechazar";
        rejectBtn.addEventListener("click", () => rejectRequest(req));

        actions.appendChild(acceptBtn);
        actions.appendChild(rejectBtn);
      } else if (currentRole && req.requester === currentRole) {
        const info = document.createElement("div");
        info.className = "helper-text";
        info.textContent = "Pendiente de respuesta del otro progenitor.";
        actions.appendChild(info);
      }

      container.appendChild(actions);
    }

    return container;
  }

  // ================= FORMULARIO =================

  function setupForm() {
    const form = document.getElementById("request-form");
    const startEl = document.getElementById("start-date");
    const endEl = document.getElementById("end-date");
    const reasonEl = document.getElementById("reason");

    startEl.min = GLOBAL_MIN_DATE;
    startEl.max = GLOBAL_MAX_DATE;
    endEl.min = GLOBAL_MIN_DATE;
    endEl.max = GLOBAL_MAX_DATE;

    form.addEventListener("submit", (e) => {
      e.preventDefault();

      if (!currentRole) {
        alert("Debes iniciar sesi√≥n como padre o madre para crear solicitudes.");
        return;
      }

      const requester = currentRole; // padre o madre seg√∫n el login
      let startStr = startEl.value;
      let endStr = endEl.value;
      const reason = reasonEl.value.trim();

      if (!startStr || !endStr || !reason) {
        alert("Por favor, rellena todas las casillas.");
        return;
      }

      const start = parseDateStr(startStr);
      const end = parseDateStr(endStr);

      if (end < start) {
        alert("La fecha de fin no puede ser anterior a la fecha de inicio.");
        return;
      }

      const clampedStart = clampToRange(start);
      const clampedEnd = clampToRange(end);

      startStr = `${clampedStart.getFullYear()}-${String(
        clampedStart.getMonth() + 1
      ).padStart(2, "0")}-${String(clampedStart.getDate()).padStart(2, "0")}`;

      endStr = `${clampedEnd.getFullYear()}-${String(
        clampedEnd.getMonth() + 1
      ).padStart(2, "0")}-${String(clampedEnd.getDate()).padStart(2, "0")}`;

      addRequest(requester, startStr, endStr, reason);

      form.reset();
    });
  }

  // ================= CONTROLES CALENDARIO =================

  function setupControls() {
    const yearSelect = document.getElementById("year-select");
    const viewModeSelect = document.getElementById("view-mode");
    const monthSelect = document.getElementById("month-select");
    const monthWrapper = document.getElementById("month-select-wrapper");
    const prevBtn = document.getElementById("prev-period");
    const nextBtn = document.getElementById("next-period");

    for (let y = MIN_YEAR; y <= MAX_YEAR; y++) {
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = String(y);
      if (y === currentYear) opt.selected = true;
      yearSelect.appendChild(opt);
    }

    function updateMonthVisibility() {
      if (viewModeSelect.value === "month") {
        monthWrapper.style.display = "inline-flex";
      } else {
        monthWrapper.style.display = "none";
      }
    }

    viewModeSelect.value = currentView;
    updateMonthVisibility();

    viewModeSelect.addEventListener("change", () => {
      currentView = viewModeSelect.value;
      updateMonthVisibility();
      renderCalendar();
    });

    yearSelect.addEventListener("change", () => {
      currentYear = parseInt(yearSelect.value, 10);
      renderCalendar();
    });

    monthSelect.value = String(currentMonth);
    monthSelect.addEventListener("change", () => {
      currentMonth = parseInt(monthSelect.value, 10);
      renderCalendar();
    });

    prevBtn.addEventListener("click", () => {
      if (currentView === "month") {
        currentMonth--;
        if (currentMonth < 0) {
          currentMonth = 11;
          currentYear = Math.max(MIN_YEAR, currentYear - 1);
          yearSelect.value = String(currentYear);
        }
        monthSelect.value = String(currentMonth);
      } else {
        currentYear = Math.max(MIN_YEAR, currentYear - 1);
        yearSelect.value = String(currentYear);
      }
      renderCalendar();
    });

    nextBtn.addEventListener("click", () => {
      if (currentView === "month") {
        currentMonth++;
        if (currentMonth > 11) {
          currentMonth = 0;
          currentYear = Math.min(MAX_YEAR, currentYear + 1);
          yearSelect.value = String(currentYear);
        }
        monthSelect.value = String(currentMonth);
      } else {
        currentYear = Math.min(MAX_YEAR, currentYear + 1);
        yearSelect.value = String(currentYear);
      }
      renderCalendar();
    });
  }

  // ================= FIREBASE LISTENERS =================

  function setupFirebaseListeners() {
    db.collection("overrides").onSnapshot(
      (snapshot) => {
        overrides = {};
        snapshot.forEach((doc) => {
          const data = doc.data();
          if (data && data.owner) {
            overrides[doc.id] = data.owner;
          }
        });
        setConnectionStatus("online");
        renderCalendar();
      },
      (err) => {
        console.error("Error escuchando overrides:", err);
        setConnectionStatus("error");
      }
    );

    db.collection("requests")
      .orderBy("createdAt", "desc")
      .onSnapshot(
        (snapshot) => {
          pendingRequests = [];
          historyRequests = [];
          snapshot.forEach((doc) => {
            const data = doc.data();
            const req = {
              id: doc.id,
              requester: data.requester,
              target: data.target,
              startDate: data.startDate,
              endDate: data.endDate,
              reason: data.reason,
              status: data.status || "pendiente",
              createdAt: data.createdAt ? data.createdAt.toDate() : null
            };
            if (req.status === "pendiente") {
              pendingRequests.push(req);
            } else {
              historyRequests.push(req);
            }
          });
          setConnectionStatus("online");
          renderRequests();
        },
        (err) => {
          console.error("Error escuchando requests:", err);
          setConnectionStatus("error");
        }
      );
  }

  // ================= AUTENTICACI√ìN =================

  function setupAuth() {
    const loginView = document.getElementById("login-view");
    const appRoot = document.getElementById("app-root");
    const loginForm = document.getElementById("login-form");
    const loginError = document.getElementById("login-error");
    const logoutBtn = document.getElementById("logout-btn");

    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const email = document.getElementById("login-email").value.trim();
      const password = document.getElementById("login-password").value;

      loginError.textContent = "";

      auth
        .signInWithEmailAndPassword(email, password)
        .catch((err) => {
          console.error("Error login:", err);
          loginError.textContent = "Correo o contrase√±a incorrectos.";
        });
    });

    logoutBtn.addEventListener("click", () => {
      auth.signOut();
    });

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        try {
          const docSnap = await db.collection("users").doc(user.uid).get();
          if (docSnap.exists) {
            const data = docSnap.data();
            currentRole = data.role; // "padre" o "madre"
          } else {
            currentRole = null;
            alert("Este usuario no tiene rol asignado (padre/madre) en la colecci√≥n 'users'.");
          }
        } catch (e) {
          console.error("Error leyendo rol:", e);
          currentRole = null;
        }

        updateUserUI();

        loginView.classList.add("hidden");
        appRoot.classList.remove("hidden");
      } else {
        currentUser = null;
        currentRole = null;
        updateUserUI();

        appRoot.classList.add("hidden");
        loginView.classList.remove("hidden");
        setConnectionStatus("connecting");
      }
    });
  }

  // ================= INICIALIZACI√ìN =================

  document.addEventListener("DOMContentLoaded", () => {
    setupControls();
    setupForm();
    setupFirebaseListeners();
    setupAuth();
    renderCalendar();
    renderRequests();
  });
</script>
</body>
</html>
