<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Custodia Familiar 2026-2027</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' x='0.1em' font-size='80'%3E%F0%9F%93%85%3C/text%3E%3C/svg%3C/svg%3E">

  <style>
    /* (TUS ESTILOS COMPLETOS ‚Äî SIN CAMBIOS) */
    /* TODA LA HOJA DE ESTILOS QUE TEN√çAS ORIGINALMENTE */
  </style>
</head>

<body>

<div class="toast-container" id="toast-container"></div>

<div id="login-view" class="login-wrapper">
  <div class="login-card">
    <div class="login-title">üìÖ Custodia Familiar</div>
    <p class="login-subtitle">Introduce tu correo y contrase√±a para acceder.</p>
    <form id="login-form">
      <div class="login-field">
        <label for="login-email">Correo electr√≥nico</label>
        <input type="email" id="login-email" required autocomplete="email" placeholder="nombre@ejemplo.com">
      </div>

      <div class="login-field">
        <label for="login-password">Contrase√±a</label>
        <input type="password" id="login-password" required autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>

      <button type="submit" class="login-btn primary-btn" id="login-submit-btn">Entrar</button>
      <p id="login-error" class="login-error"></p>
    </form>
  </div>
</div>

<div id="app-root" class="app hidden">
  <header class="topbar">
    <div class="topbar-left" style="display:flex;align-items:center;gap:10px;">
      <div class="logo-icon">üìÖ</div>
      <div>
        <div class="app-name">Custodia Familiar</div>
        <div class="status-pill status-connecting" id="status-pill">
          <span class="status-dot"></span>
          <span id="status-text">Conectando...</span>
        </div>
      </div>
    </div>

    <div class="topbar-right">
      <select id="year-select" class="year-select"></select>
      <div class="user-info">
        <span class="user-role-label" id="user-role-label">Usuario</span>
        <button type="button" id="logout-btn" class="logout-btn">Salir</button>
      </div>
    </div>
  </header>

  <div class="layout">
    <section class="calendar-wrapper">
      <div class="calendar-header">
        <button id="prev-period" class="nav-arrow">‚Äπ</button>
        <div class="month-nav">
          <div class="calendar-title" id="calendar-title"></div>
        </div>
        <button id="next-period" class="nav-arrow">‚Ä∫</button>
      </div>

      <div class="calendar-subheader">
        <div class="legend">
          <span class="legend-item"><span style="width:12px;height:12px;background:var(--mother-color);border-radius:2px;border:1px solid #ccc;"></span> Madre üë©</span>
          <span class="legend-item"><span style="width:12px;height:12px;background:var(--father-color);border-radius:2px;border:1px solid #ccc;"></span> Padre üë®</span>
        </div>
      </div>

      <div id="calendar-grid" class="calendar-grid"></div>
    </section>

    <section class="side-panel">

      <div class="card">
        <div class="panel-title">‚ûï Nueva solicitud</div>
        <form id="request-form">
          <div class="field-group">
            <label>Solicitante: <span id="whoami-label" style="font-weight:600;">...</span></label>
          </div>

          <div class="field-group">
            <label>Fechas</label>
            <div style="display:flex; gap:10px;">
              <input type="date" id="start-date" required>
              <input type="date" id="end-date" required>
            </div>
          </div>

          <div class="field-group">
            <label for="reason">Motivo</label>
            <textarea id="reason" placeholder="Ej: Viaje de trabajo..." required></textarea>
          </div>

          <button type="submit" class="primary-btn">Enviar Solicitud</button>
        </form>
      </div>

      <div class="card">
        <h3 class="panel-title active">Pendientes de acci√≥n</h3>
        <div class="requests-list" id="pending-requests"></div>
      </div>

      <div class="card">
        <h3 class="panel-title">Historial</h3>
        <div class="requests-list" id="history-requests"></div>
      </div>

    </section>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
/* ===========================================================
   CONFIG FIREBASE
=========================================================== */
const firebaseConfig = {
  apiKey: "AIzaSyAwgk4_l0zvaCUCgm1CjqqqXjJHr5KPBjc",
  authDomain: "custodia-familiar.firebaseapp.com",
  projectId: "custodia-familiar",
  storageBucket: "custodia-familiar.firebasestorage.app",
  messagingSenderId: "1038952432258",
  appId: "1:1038952432258:web:7608d6a48d8ad8308a6a9b"
};

firebase.initializeApp(firebaseConfig);
const db   = firebase.firestore();
const auth = firebase.auth();

/* ===========================================================
   FUNCI√ìN TELEGRAM (V√çA CLOUD FUNCTION HTTP)
=========================================================== */
function sendTelegramMessage(text) {
  const url = "https://sendtelegram-jd4jwaesba-uc.a.run.app";

  fetch(url, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({ text }),
  })
    .then((res) => res.json())
    .then((data) => {
      if (!data || !data.ok) {
        console.error("Error respuesta sendTelegram:", data);
      }
    })
    .catch((err) => {
      console.error("Error al llamar a sendTelegram:", err);
    });
}


  fetch(url, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ text })
  })
  .then(res => res.json())
  .then(data => {
    if (!data || !data.ok) {
      console.error("Error respuesta sendTelegram:", data);
    }
  })
  .catch(err => console.error("Error al llamar a sendTelegram:", err));
}


/* ===========================================================
   (SIGUE EL RESTO DEL SCRIPT EXACTAMENTE IGUAL)
=========================================================== */

const MIN_YEAR = 2026;
const MAX_YEAR = 2027;
const GLOBAL_MIN_DATE = `${MIN_YEAR}-01-01`;
const GLOBAL_MAX_DATE = `${MAX_YEAR}-12-31`;

let currentYear = 2026;
let currentMonth = 0;
let currentUser = null;
let currentRole = null;
let overrides = {};
let pendingRequests = [];
let historyRequests = [];

const monthNames = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
const weekDayNames = ["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"];
const BASE_MONDAY = new Date(2026, 0, 5, 12, 0, 0);


/* ===========================================================
   HELPERS, RENDERIZADO DEL CALENDARIO, RENDER LISTAS, ETC
=========================================================== */

/* ... (TODO TU SCRIPT COMPLETO ORIGINAL AQU√ç, SIN CAMBIOS) ... */
/* Lo √∫nico modificado es la funci√≥n sendTelegramMessage arriba */

/* ===========================================================
   L√ìGICA DE ENV√çO DE SOLICITUDES + NOTIFICACI√ìN TELEGRAM
=========================================================== */

document.getElementById("request-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!currentUser || !currentRole) return;

  const sDate  = document.getElementById("start-date").value;
  const eDate  = document.getElementById("end-date").value;
  const reason = document.getElementById("reason").value.trim();

  try {
    await db.collection("requests").add({
      requesterUid: currentUser.uid,
      requesterRole: currentRole,
      startDate: sDate,
      endDate: eDate,
      reason: reason,
      status: "pendiente",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    showToast("Solicitud enviada");
    e.target.reset();

    const quien = currentRole.charAt(0).toUpperCase() + currentRole.slice(1);

    sendTelegramMessage(
      `üì¢ *NUEVA SOLICITUD*\nDe: ${quien}\nüìÖ ${sDate} a ${eDate}\nüí¨ "${reason}"`
    );

  } catch (err) {
    console.error(err);
    showToast("Error al enviar", "error");
  }
});


/* ===========================================================
   FIN INIT
=========================================================== */

document.addEventListener("DOMContentLoaded", () => {
  const sd = document.getElementById("start-date");
  const ed = document.getElementById("end-date");

  sd.min = GLOBAL_MIN_DATE;
  sd.max = GLOBAL_MAX_DATE;
  ed.min = GLOBAL_MIN_DATE;
  ed.max = GLOBAL_MAX_DATE;

  const ys = document.getElementById("year-select");
  [2026,2027].forEach(y => {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y;
    if (y === currentYear) opt.selected = true;
    ys.appendChild(opt);
  });

  renderCalendar();
});

</script>
</body>
</html>

