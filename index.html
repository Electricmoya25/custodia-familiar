<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Custodia Familiar 2026-2027</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' x='0.1em' font-size='80'%3E%F0%9F%93%85%3C/text%3E%3C/svg%3E">
  <style>
    :root {
      --mother-color: #fce7f3; --father-color: #dbeafe;
      --mother-text: #be185d; --father-text: #1e40af;
      --accent-color: #7c3aed; --accent-soft: #ede9fe;
      --text-main: #111827; --bg-main: #f8fafc;
      --success: #10b981; --error: #ef4444;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: var(--bg-main); color: var(--text-main); padding-bottom: 50px; }
    .hidden { display: none !important; }

    /* UI Elements */
    .toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
    .toast { background: #333; color: #fff; padding: 12px 24px; border-radius: 50px; font-size: 0.9rem; opacity: 0; transform: translateY(20px); transition: all 0.4s ease; display: flex; align-items: center; gap: 10px; }
    .toast.visible { opacity: 1; transform: translateY(0); }
    .toast.success { background: var(--success); } .toast.error { background: var(--error); }

    .login-wrapper { min-height: 100vh; display:flex; align-items:center; justify-content:center; padding:20px; background: radial-gradient(circle at top, #ede9fe, #f3f4fb); }
    .login-card { background:#fff; max-width:380px; width:100%; border-radius:24px; box-shadow:0 20px 45px rgba(15,23,42,0.15); padding:32px; }
    .primary-btn { width:100%; padding:12px; border-radius:12px; border:none; background:var(--accent-color); color:white; font-weight:600; cursor:pointer; transition:0.2s; }
    .primary-btn:hover { background:#6d28d9; }

    .topbar { padding:12px 16px; border-radius:20px; background:#fff; margin-bottom:16px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    .layout { display:grid; grid-template-columns: 2fr 1fr; gap:16px; padding:0 10px; max-width:1200px; margin:0 auto; }
    @media (max-width:850px) { .layout { grid-template-columns: 1fr; } }

    .calendar-wrapper { background:#fff; border-radius:24px; padding:20px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    .calendar-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    .month-table td { height: 54px; position: relative; border-radius: 12px; vertical-align: top; cursor: default; }
    .day-mother { background: var(--mother-color); color: var(--mother-text); }
    .day-father { background: var(--father-color); color: var(--father-text); }
    .day-number { position: absolute; top: 4px; left: 6px; font-size: 0.85rem; font-weight: 700; z-index: 2; }
    .owner-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; opacity: 0.25; pointer-events: none; z-index: 1; filter: grayscale(0.2); }
    .day-overridden::after { content: "‚áÑ"; position: absolute; top: 2px; right: 4px; font-size: 0.8rem; opacity: 0.7; z-index: 3; }
    .today-marker { position: absolute; bottom: 4px; right: 4px; width: 6px; height: 6px; background: var(--accent-color); border-radius: 50%; z-index: 3; }

    .card { background:#fff; border-radius:20px; padding:16px; margin-bottom:16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    .panel-title { font-weight:700; margin-bottom:12px; color:var(--text-main); }
    
    /* ESTILOS DEL HISTORIAL MEJORADOS */
    .requests-list { max-height:400px; overflow-y:auto; padding-right:5px; }
    .request-item { padding:12px; border:1px solid #e5e7eb; border-radius:12px; margin-bottom:10px; background:#f9fafb; font-size:0.9rem; }
    .req-header { display:flex; justify-content:space-between; margin-bottom:6px; font-weight:600; font-size:0.8rem; text-transform:uppercase; color:#6b7280; }
    .req-dates { font-weight:700; color:#111827; margin-bottom:4px; }
    .req-reason { font-style:italic; color:#4b5563; margin-bottom:8px; background:#fff; padding:6px; border-radius:6px; border:1px dashed #e5e7eb; }
    .req-status { display:inline-block; padding:2px 8px; border-radius:99px; font-size:0.75rem; font-weight:700; }
    .status-aceptado { background:#dcfce7; color:#166534; }
    .status-rechazado { background:#fee2e2; color:#991b1b; }
    .status-pendiente { background:#fef3c7; color:#92400e; }

    input, textarea, select { width:100%; padding:10px; border-radius:8px; border:1px solid #d1d5db; margin-bottom:10px; font-family:inherit; }
  </style>
</head>
<body>

<div class="toast-container" id="toast-container"></div>

<div id="login-view" class="login-wrapper">
  <div class="login-card">
    <h2 style="margin-top:0; color:var(--accent-color);">üìÖ Custodia</h2>
    <form id="login-form">
      <label style="display:block;margin-bottom:5px;font-size:0.9rem;">Email</label>
      <input type="email" id="login-email" required placeholder="email@ejemplo.com">
      <label style="display:block;margin-bottom:5px;font-size:0.9rem;">Contrase√±a</label>
      <input type="password" id="login-password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      <button type="submit" class="primary-btn" id="login-submit-btn">Entrar</button>
      <p id="login-error" style="color:red;text-align:center;font-size:0.85rem;margin-top:10px;"></p>
    </form>
  </div>
</div>

<div id="app-root" class="app hidden">
  <header class="topbar">
    <div style="display:flex;align-items:center;gap:10px;">
      <span style="font-size:1.5rem;">üóìÔ∏è</span>
      <span style="font-weight:bold;">Custodia Familiar</span>
    </div>
    <div style="display:flex;align-items:center;gap:10px;">
      <span id="user-role-label" style="font-weight:600;font-size:0.9rem;">...</span>
      <button id="logout-btn" style="padding:5px 10px;border-radius:20px;border:1px solid #ccc;background:white;cursor:pointer;">Salir</button>
    </div>
  </header>

  <div class="layout">
    <section class="calendar-wrapper">
      <div class="calendar-header">
        <button id="prev-period" style="padding:5px 15px;cursor:pointer;">‚Äπ</button>
        <h2 id="calendar-title" style="margin:0;font-size:1.2rem;"></h2>
        <button id="next-period" style="padding:5px 15px;cursor:pointer;">‚Ä∫</button>
      </div>
      <div id="calendar-grid" class="calendar-grid"></div>
    </section>

    <section class="side-panel">
      <div class="card">
        <div class="panel-title">‚ûï Solicitar cambio</div>
        <form id="request-form">
          <div style="display:flex;gap:5px;">
            <input type="date" id="start-date" required>
            <input type="date" id="end-date" required>
          </div>
          <textarea id="reason" required placeholder="Motivo del cambio..." style="min-height:60px;"></textarea>
          <button type="submit" class="primary-btn">Enviar Solicitud</button>
        </form>
      </div>

      <div class="card">
        <div class="panel-title">‚è≥ Pendientes</div>
        <div class="requests-list" id="pending-requests"></div>
      </div>

      <div class="card">
        <div class="panel-title">üìú Historial Completo</div>
        <div class="requests-list" id="history-requests"></div>
      </div>
    </section>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
  // CONFIGURACI√ìN FIREBASE
  const firebaseConfig = {
    apiKey: "AIzaSyAwgk4_l0zvaCUCgm1CjqqqXjJHr5KPBjc",
    authDomain: "custodia-familiar.firebaseapp.com",
    projectId: "custodia-familiar",
    storageBucket: "custodia-familiar.firebasestorage.app",
    messagingSenderId: "1038952432258",
    appId: "1:1038952432258:web:7608d6a48d8ad8308a6a9b"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  // VARIABLES GLOBALES
  const MIN_YEAR = 2026; const MAX_YEAR = 2027;
  let currentYear = 2026; let currentMonth = 0;
  let currentUser = null; let currentRole = null;
  let overrides = {}; let pendingRequests = []; let historyRequests = [];
  const monthNames = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
  const BASE_MONDAY = new Date(2026, 0, 5, 12, 0, 0); // 5 Ene 2026

  // UI HELPERS
  function showToast(msg, type='success') {
    const c = document.getElementById('toast-container');
    const el = document.createElement('div'); el.className = `toast ${type}`; el.innerText = msg;
    c.appendChild(el); requestAnimationFrame(()=>el.classList.add('visible'));
    setTimeout(()=>{ el.classList.remove('visible'); setTimeout(()=>el.remove(),300); }, 3000);
  }

  // LOGICA CALENDARIO
  function formatDateKey(y, m, d) { return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }

  function getBaseOwner(year, monthIndex, day) {
    const date = new Date(year, monthIndex, day, 12, 0, 0);
    if (date.getFullYear() < MIN_YEAR || date.getFullYear() > MAX_YEAR) return null;
    const diffMs = date - BASE_MONDAY;
    const diffDays = Math.round(diffMs / 86400000);
    const weekIndex = Math.floor(diffDays / 7);
    const isEven = Math.abs(weekIndex) % 2 === 0;
    // Semana 0 (5 Ene) es Par -> PADRE
    return isEven ? "padre" : "madre";
  }

  function renderCalendar() {
    const grid = document.getElementById("calendar-grid");
    document.getElementById("calendar-title").innerText = `${monthNames[currentMonth]} ${currentYear}`;
    grid.innerHTML = "";
    
    const monthDiv = document.createElement("div"); monthDiv.className = "month";
    const table = document.createElement("table"); table.className = "month-table";
    table.innerHTML = `<thead><tr><th>L</th><th>M</th><th>X</th><th>J</th><th>V</th><th>S</th><th>D</th></tr></thead>`;
    const tbody = document.createElement("tbody");
    
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    let startDay = new Date(currentYear, currentMonth, 1).getDay();
    startDay = (startDay === 0) ? 6 : startDay - 1;

    let dayCounter = 1; let finished = false;
    while (!finished) {
      const tr = document.createElement("tr");
      for (let i=0; i<7; i++) {
        const td = document.createElement("td");
        if (dayCounter <= daysInMonth && (dayCounter > 1 || i >= startDay)) {
          const key = formatDateKey(currentYear, currentMonth, dayCounter);
          const owner = overrides[key] || getBaseOwner(currentYear, currentMonth, dayCounter);
          
          td.className = owner === "padre" ? "day-father" : "day-mother";
          if (overrides[key]) td.classList.add("day-overridden");
          
          td.innerHTML = `
            <span class="day-number">${dayCounter}</span>
            <div class="owner-icon">${owner === "madre" ? "üë©" : "üë®"}</div>
          `;
          dayCounter++;
        } else { td.style.background = "transparent"; }
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
      if (dayCounter > daysInMonth) finished = true;
    }
    table.appendChild(tbody); monthDiv.appendChild(table); grid.appendChild(monthDiv);
  }

  // RENDERIZADO DE LISTAS (HISTORIAL COMPLETO)
  function renderLists() {
    const pEl = document.getElementById("pending-requests");
    const hEl = document.getElementById("history-requests");
    pEl.innerHTML = ""; hEl.innerHTML = "";

    // Pendientes (Simple)
    pendingRequests.forEach(req => {
      pEl.innerHTML += `
        <div class="request-item" style="border-left:4px solid orange;">
          <div class="req-dates">${req.startDate} ‚ûî ${req.endDate}</div>
          <div class="req-reason">"${req.reason}"</div>
          <div style="font-size:0.8rem;color:#666;">Solicitado por: <strong>${req.requesterRole.toUpperCase()}</strong></div>
        </div>`;
    });

    // Historial (Completo y detallado)
    if(historyRequests.length === 0) hEl.innerHTML = "<div style='color:#ccc;text-align:center;'>Sin historial</div>";
    
    historyRequests.forEach(req => {
      const statusClass = req.status === 'aceptado' ? 'status-aceptado' : 'status-rechazado';
      const icon = req.status === 'aceptado' ? '‚úÖ' : '‚ùå';
      
      hEl.innerHTML += `
        <div class="request-item" style="border-left:4px solid ${req.status==='aceptado'?'#10b981':'#ef4444'};">
          <div class="req-header">
            <span>De: ${req.requesterRole}</span>
            <span class="req-status ${statusClass}">${icon} ${req.status.toUpperCase()}</span>
          </div>
          <div class="req-dates">üìÖ ${req.startDate} al ${req.endDate}</div>
          <div class="req-reason">Motivo: "${req.reason}"</div>
        </div>`;
    });
  }

  // LOGIN & AUTH
  document.getElementById("login-form").addEventListener("submit", (e)=>{
    e.preventDefault();
    auth.signInWithEmailAndPassword(document.getElementById("login-email").value, document.getElementById("login-password").value)
      .catch(err => document.getElementById("login-error").innerText = "Credenciales incorrectas");
  });
  document.getElementById("logout-btn").onclick = () => auth.signOut();

  auth.onAuthStateChanged(async (user) => {
    if(user) {
      const snap = await db.collection("users").doc(user.uid).get();
      if(snap.exists) {
        currentRole = snap.data().role;
        document.getElementById("user-role-label").innerText = currentRole === "padre" ? "üë® Padre" : "üë© Madre";
        document.getElementById("login-view").classList.add("hidden");
        document.getElementById("app-root").classList.remove("hidden");
        initData();
      } else { alert("Usuario sin rol en base de datos."); auth.signOut(); }
    } else {
      document.getElementById("login-view").classList.remove("hidden");
      document.getElementById("app-root").classList.add("hidden");
    }
  });

  function initData() {
    renderCalendar();
    db.collection("overrides").onSnapshot(s => { overrides={}; s.forEach(d=>overrides[d.id]=d.data().owner); renderCalendar(); });
    db.collection("requests").orderBy("createdAt", "desc").onSnapshot(s => {
      pendingRequests=[]; historyRequests=[];
      s.forEach(d => {
        const item = {id:d.id, ...d.data()};
        if(item.status==="pendiente") pendingRequests.push(item); else historyRequests.push(item);
      });
      renderLists();
    });
  }

  // EVENTOS
  document.getElementById("prev-period").onclick = () => { currentMonth--; if(currentMonth<0){currentMonth=11;currentYear--;} renderCalendar(); };
  document.getElementById("next-period").onclick = () => { currentMonth++; if(currentMonth>11){currentMonth=0;currentYear++;} renderCalendar(); };
  
  document.getElementById("request-form").onsubmit = async (e) => {
    e.preventDefault();
    if(!currentRole) return;
    try {
      await db.collection("requests").add({
        requesterUid: auth.currentUser.uid, requesterRole: currentRole,
        startDate: document.getElementById("start-date").value,
        endDate: document.getElementById("end-date").value,
        reason: document.getElementById("reason").value,
        status: "pendiente",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      showToast("Solicitud enviada"); e.target.reset();
    } catch(e) { showToast("Error al enviar", "error"); }
  };
</script>
</body>
</html>
